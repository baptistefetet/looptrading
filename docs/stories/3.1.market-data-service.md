# Story 3.1: Service de données de marché

## Status
Ready for Review

## Story
**As a** user,
**I want** real-time market data for stocks,
**so that** I can analyze current prices and volumes.

## Acceptance Criteria
1. Service `MarketDataService` créé avec Yahoo Finance
2. Endpoint `GET /api/stocks/:symbol/quote` retourne prix actuel
3. Endpoint `GET /api/stocks/:symbol/history` retourne historique OHLCV
4. Support marchés US et EU (suffixes .PA, .DE, etc.)
5. Rate limiting respecté (Yahoo Finance)
6. Cache des données (TTL 15 minutes)

## Tasks / Subtasks
- [x] Créer MarketDataService (AC: 1)
  - [x] Installer `yahoo-finance2` ou équivalent
  - [x] Créer classe service
  - [x] Configurer client avec options
- [x] Endpoint quote temps réel (AC: 2)
  - [x] Route `GET /api/stocks/:symbol/quote`
  - [x] Données : price, change, changePercent, volume, high, low
  - [x] Schema Zod pour réponse
- [x] Endpoint historique OHLCV (AC: 3)
  - [x] Route `GET /api/stocks/:symbol/history`
  - [x] Query params : period (1d, 1w, 1m, 3m, 1y)
  - [x] Données : date, open, high, low, close, volume
- [x] Support marchés internationaux (AC: 4)
  - [x] Mapping symbols EU (.PA pour Paris, .DE pour Francfort)
  - [x] Détection automatique du marché
  - [x] Gestion devises
- [x] Implémenter rate limiting (AC: 5)
  - [x] Queue de requêtes
  - [x] Délai entre appels
  - [x] Retry sur erreur 429
- [x] Configurer cache (AC: 6)
  - [x] Cache par symbol
  - [x] TTL 15 minutes (NFR3)
  - [x] Invalidation sélective

## Dev Notes
_À compléter après création du document d'architecture_

### Architecture References
- API données : Yahoo Finance (PRD section 4.3)
- NFR3 : Latence données ≤ 15 minutes
- NFR8 : APIs gratuites uniquement

### Testing
_Standards de test à définir dans le document d'architecture_

## File List
| File | Action | Description |
|------|--------|-------------|
| `src/server/services/MarketDataService.ts` | Created | Service with quote, history, rate limiting, cache, EU market support |
| `src/server/routes/stocks.ts` | Created | Routes GET /api/stocks/:symbol/quote and /history |
| `src/server/routes/index.ts` | Modified | Register stocksRoutes |
| `src/shared/types.ts` | Modified | Added StockQuote, OHLCVBar, StockHistory types |
| `src/server/__tests__/stocks.test.ts` | Created | Integration tests for stocks endpoints |
| `src/server/__tests__/market-data-service.test.ts` | Created | Unit tests for MarketDataService |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Debug Log References
None

### Completion Notes
- `yahoo-finance2` was already installed from Story 2.1/2.3
- Used existing `CacheService` singleton with `market:` prefix namespace
- Rate limiter uses 200ms delay between calls + exponential backoff retry on 429
- EU market detection via symbol suffix mapping (14 exchanges)
- All 56 tests pass (13 new + 43 existing)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 0.1 | Création initiale de la story | Sarah (PO) |
| 2026-01-31 | 1.0 | Implementation complete - all tasks done | James (Dev) |
