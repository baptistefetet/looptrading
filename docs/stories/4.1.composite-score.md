# Story 4.1: Calcul du score composite

## Status
Ready for Review

## Story
**As a** user,
**I want** a composite score for each stock,
**so that** I can quickly identify opportunities.

## Acceptance Criteria
1. Service `ScoringService` implémentant la formule :
   - Tendance LT (25%) : position vs SMA200
   - Tendance MT (20%) : position vs SMA50
   - Momentum (20%) : RSI + MACD
   - Volume (15%) : vs moyenne 20j
   - Sentiment (10%) : basé sur news récentes
   - Proximité support (10%) : distance aux supports
2. Score normalisé 0-100
3. Endpoint `GET /api/stocks/:symbol/score` retourne le détail
4. Tests unitaires avec scénarios variés

## Tasks / Subtasks
- [x] Créer ScoringService (AC: 1)
  - [x] Classe service avec injection dépendances
  - [x] Méthode principale `calculateScore(symbol)`
- [x] Implémenter composante Tendance LT - 25% (AC: 1)
  - [x] Position prix vs SMA200
  - [x] Au-dessus = positif, en-dessous = négatif
  - [x] Normalisation 0-25
- [x] Implémenter composante Tendance MT - 20% (AC: 1)
  - [x] Position prix vs SMA50
  - [x] Croisements SMA20/SMA50
  - [x] Normalisation 0-20
- [x] Implémenter composante Momentum - 20% (AC: 1)
  - [x] RSI : 30-70 optimal, extrêmes pénalisés
  - [x] MACD : histogramme positif = bonus
  - [x] Normalisation 0-20
- [x] Implémenter composante Volume - 15% (AC: 1)
  - [x] Ratio volume actuel / moyenne 20j
  - [x] Volume élevé = confirmation
  - [x] Normalisation 0-15
- [x] Implémenter composante Sentiment - 10% (AC: 1)
  - [x] Analyse news récentes (positif/négatif)
  - [x] Nombre de news récentes
  - [x] Normalisation 0-10
- [x] Implémenter composante Support - 10% (AC: 1)
  - [x] Identifier supports (plus bas récents)
  - [x] Distance au support
  - [x] Normalisation 0-10
- [x] Normaliser score total (AC: 2)
  - [x] Somme des composantes = 0-100
  - [x] Arrondi à l'entier
- [x] Créer endpoint score (AC: 3)
  - [x] Route `GET /api/stocks/:symbol/score`
  - [x] Retourner score total + détail par composante
  - [x] Schema Zod
- [x] Écrire tests unitaires (AC: 4)
  - [x] Scénario haussier fort (score > 80)
  - [x] Scénario baissier fort (score < 30)
  - [x] Scénario neutre (score ~50)
  - [x] Tests edge cases

## Dev Notes
_À compléter après création du document d'architecture_

### Architecture References
- FR3 : Score composite 0-100 avec pondération définie
- Seuil alerte > 75 (FR4)

### Score Formula
```
Score = Tendance_LT × 0.25
      + Tendance_MT × 0.20
      + Momentum × 0.20
      + Volume × 0.15
      + Sentiment × 0.10
      + Proximité_Support × 0.10
```

### Dependencies
- Story 3.2 (SMA/EMA) doit être complétée
- Story 3.3 (RSI/MACD/Volume) doit être complétée
- Story 2.3 (News) pour composante sentiment

### Testing
_Standards de test à définir dans le document d'architecture_

## File List
| File | Action | Description |
|------|--------|-------------|
| `src/server/services/ScoringService.ts` | Created | Scoring service with 6 components and composite score calculation |
| `src/server/routes/stocks.ts` | Modified | Added GET /api/stocks/:symbol/score endpoint |
| `src/server/__tests__/scoring-service.test.ts` | Created | 44 unit tests for all scoring components |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Debug Log References
None

### Completion Notes
- All 6 scoring components implemented as pure exported functions for testability
- `computeComponents` method extracted for unit testing without DB/API dependencies
- Score persisted to `StockData.score` field (already in schema)
- 44 tests covering bullish (>80), bearish (<30), neutral (~50), and edge cases
- All 188 tests pass (12 test files)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 0.1 | Création initiale de la story | Sarah (PO) |
| 2026-01-31 | 1.0 | Implementation complete | James (Dev) |
