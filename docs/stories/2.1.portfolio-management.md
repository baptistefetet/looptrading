# Story 2.1: Gestion du portfolio manuel

## Status
Done

## Story
**As a** user,
**I want** to manage my portfolio positions manually,
**so that** I can track my holdings alongside market opportunities.

## Acceptance Criteria
1. Table `Position` : symbol, quantity, avgCost, dateAcquired, notes
2. Endpoint `GET /api/portfolio/positions` retourne les positions avec P&L calculé
3. Endpoint `POST /api/portfolio/positions` pour ajouter une position
4. Endpoint `PUT /api/portfolio/positions/:id` pour modifier une position
5. Endpoint `DELETE /api/portfolio/positions/:id` pour supprimer une position
6. P&L calculé dynamiquement avec prix Yahoo Finance

## Tasks / Subtasks
- [x] Créer table Position (AC: 1)
  - [x] Migration Prisma (already in schema from Story 1.2)
  - [x] Champs : id, symbol, quantity, avgCost, dateAcquired, notes, createdAt, updatedAt
  - [x] Validation : quantity > 0, avgCost > 0
- [x] Endpoint liste positions (AC: 2)
  - [x] Route `GET /api/portfolio/positions`
  - [x] Pour chaque position, fetch prix actuel Yahoo Finance
  - [x] Calculer : marketValue, unrealizedPnL, unrealizedPnLPercent
  - [x] Cache des prix (éviter trop d'appels Yahoo)
- [x] Endpoint ajout position (AC: 3)
  - [x] Route `POST /api/portfolio/positions`
  - [x] Body : symbol, quantity, avgCost, dateAcquired (optionnel), notes (optionnel)
  - [x] Validation symbol existe (vérif Yahoo Finance)
  - [x] Retourner la position créée avec P&L
- [x] Endpoint modification position (AC: 4)
  - [x] Route `PUT /api/portfolio/positions/:id`
  - [x] Permettre modification de tous les champs
  - [x] Retourner la position mise à jour
- [x] Endpoint suppression position (AC: 5)
  - [x] Route `DELETE /api/portfolio/positions/:id`
  - [x] Confirmation requise côté frontend
- [x] Calcul P&L dynamique (AC: 6)
  - [x] Fetch prix Yahoo Finance
  - [x] unrealizedPnL = (currentPrice - avgCost) × quantity
  - [x] unrealizedPnLPercent = (currentPrice - avgCost) / avgCost × 100

## Dev Notes

### Architecture References
- Remplacement de l'intégration IBKR par gestion manuelle (simplification)
- Utilise Yahoo Finance pour les prix actuels (déjà disponible via Story 3.1)

### API Response Format
```typescript
interface Position {
  id: string;
  symbol: string;
  quantity: number;
  avgCost: number;
  dateAcquired: string | null;
  notes: string | null;
  // Calculés dynamiquement
  currentPrice: number;
  marketValue: number;
  unrealizedPnL: number;
  unrealizedPnLPercent: number;
}

interface PortfolioSummary {
  positions: Position[];
  totalValue: number;
  totalCost: number;
  totalPnL: number;
  totalPnLPercent: number;
}
```

### Dependencies
- Story 3.1 (MarketDataService) pour les prix actuels

### Testing
_Standards de test à définir dans le document d'architecture_

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 0.1 | Création initiale (IBKR) | Sarah (PO) |
| 2026-01-25 | 0.2 | Réécriture : portfolio manuel sans IBKR | Winston (Architect) |
