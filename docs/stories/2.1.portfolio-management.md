# Story 2.1: Gestion du portfolio manuel

## Status
Draft

## Story
**As a** user,
**I want** to manage my portfolio positions manually,
**so that** I can track my holdings alongside market opportunities.

## Acceptance Criteria
1. Table `Position` : symbol, quantity, avgCost, dateAcquired, notes
2. Endpoint `GET /api/portfolio/positions` retourne les positions avec P&L calculé
3. Endpoint `POST /api/portfolio/positions` pour ajouter une position
4. Endpoint `PUT /api/portfolio/positions/:id` pour modifier une position
5. Endpoint `DELETE /api/portfolio/positions/:id` pour supprimer une position
6. P&L calculé dynamiquement avec prix Yahoo Finance

## Tasks / Subtasks
- [ ] Créer table Position (AC: 1)
  - [ ] Migration Prisma
  - [ ] Champs : id, symbol, quantity, avgCost, dateAcquired, notes, createdAt, updatedAt
  - [ ] Validation : quantity > 0, avgCost > 0
- [ ] Endpoint liste positions (AC: 2)
  - [ ] Route `GET /api/portfolio/positions`
  - [ ] Pour chaque position, fetch prix actuel Yahoo Finance
  - [ ] Calculer : marketValue, unrealizedPnL, unrealizedPnLPercent
  - [ ] Cache des prix (éviter trop d'appels Yahoo)
- [ ] Endpoint ajout position (AC: 3)
  - [ ] Route `POST /api/portfolio/positions`
  - [ ] Body : symbol, quantity, avgCost, dateAcquired (optionnel), notes (optionnel)
  - [ ] Validation symbol existe (vérif Yahoo Finance)
  - [ ] Retourner la position créée avec P&L
- [ ] Endpoint modification position (AC: 4)
  - [ ] Route `PUT /api/portfolio/positions/:id`
  - [ ] Permettre modification de tous les champs
  - [ ] Retourner la position mise à jour
- [ ] Endpoint suppression position (AC: 5)
  - [ ] Route `DELETE /api/portfolio/positions/:id`
  - [ ] Confirmation requise côté frontend
- [ ] Calcul P&L dynamique (AC: 6)
  - [ ] Fetch prix Yahoo Finance
  - [ ] unrealizedPnL = (currentPrice - avgCost) × quantity
  - [ ] unrealizedPnLPercent = (currentPrice - avgCost) / avgCost × 100

## Dev Notes

### Architecture References
- Remplacement de l'intégration IBKR par gestion manuelle (simplification)
- Utilise Yahoo Finance pour les prix actuels (déjà disponible via Story 3.1)

### API Response Format
```typescript
interface Position {
  id: string;
  symbol: string;
  quantity: number;
  avgCost: number;
  dateAcquired: string | null;
  notes: string | null;
  // Calculés dynamiquement
  currentPrice: number;
  marketValue: number;
  unrealizedPnL: number;
  unrealizedPnLPercent: number;
}

interface PortfolioSummary {
  positions: Position[];
  totalValue: number;
  totalCost: number;
  totalPnL: number;
  totalPnLPercent: number;
}
```

### Dependencies
- Story 3.1 (MarketDataService) pour les prix actuels

### Testing
_Standards de test à définir dans le document d'architecture_

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 0.1 | Création initiale (IBKR) | Sarah (PO) |
| 2026-01-25 | 0.2 | Réécriture : portfolio manuel sans IBKR | Winston (Architect) |
