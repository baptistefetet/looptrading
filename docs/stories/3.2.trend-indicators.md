# Story 3.2: Calcul des indicateurs de tendance

## Status
Done

## Story
**As a** user,
**I want** trend indicators calculated for stocks,
**so that** I can identify market direction.

## Acceptance Criteria
1. Calcul SMA (20, 50, 200 périodes)
2. Calcul EMA (9, 21 périodes)
3. Endpoint `GET /api/stocks/:symbol/indicators` inclut ces indicateurs
4. Tests unitaires validant les calculs vs valeurs de référence
5. Indicateurs stockés en base pour historique

## Tasks / Subtasks
- [x] Implémenter calcul SMA (AC: 1)
  - [x] Fonction `calculateSMA(prices, period)`
  - [x] SMA 20 jours
  - [x] SMA 50 jours
  - [x] SMA 200 jours
- [x] Implémenter calcul EMA (AC: 2)
  - [x] Fonction `calculateEMA(prices, period)`
  - [x] EMA 9 jours
  - [x] EMA 21 jours
  - [x] Multiplier = 2 / (period + 1)
- [x] Créer endpoint indicators (AC: 3)
  - [x] Route `GET /api/stocks/:symbol/indicators`
  - [x] Inclure tous les indicateurs
  - [x] Schema de réponse structuré
- [x] Écrire tests unitaires (AC: 4)
  - [x] Valeurs de référence calculées manuellement
  - [x] Comparaison avec formules vérifiées
  - [x] Tests edge cases (données insuffisantes)
- [x] Persister en base (AC: 5)
  - [x] Colonnes StockData (sma20, sma50, sma200, ema9, ema21 déjà dans schema)
  - [x] Mise à jour via computeIndicators()
  - [x] Timestamp de calcul (updatedAt)

## Dev Notes

### Architecture References
- FR10 : SMA (20, 50, 200), EMA (9, 21)
- Indicateurs pour score composite (FR3)

### Formulas
```
SMA = Σ(prix sur n périodes) / n
EMA = (Prix actuel × k) + (EMA précédent × (1-k))
où k = 2 / (n + 1)
```

### Implementation Details
- `IndicatorService` in `src/server/services/IndicatorService.ts`
- Pure functions: `calculateSMA()`, `calculateEMA()`, `calculateEMASeries()`
- `computeIndicators(symbol)` fetches StockData from DB, calculates all indicators, persists back
- `getIndicators(symbol)` returns latest stored indicators without recomputing
- Endpoint supports `?recompute=true` query param to force recalculation
- EMA seeded with SMA of first N prices (standard approach)
- All indicators persisted per-row in StockData table

### Dependencies
- Story 3.1 (MarketDataService) - Done

### Testing
- 18 unit tests for SMA/EMA calculations (edge cases, reference values)
- 7 integration tests for endpoint (404, insufficient data, compute, persist, case-insensitive)
- Total: 25 new tests, all passing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 0.1 | Création initiale de la story | Sarah (PO) |
| 2026-01-31 | 1.0 | Implementation complete | Dev |
