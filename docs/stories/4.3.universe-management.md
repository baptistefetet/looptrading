# Story 4.3: Gestion de l'univers d'actions

## Status
Done

## Story
**As a** user,
**I want** to define which stocks to monitor,
**so that** I can focus on relevant markets.

## Acceptance Criteria
1. Table `Universe` : symbol, market, sector, active
2. Endpoint `POST /api/stocks` pour ajouter des actions
3. Endpoint `DELETE /api/stocks/:symbol` pour retirer
4. Import bulk via CSV (symboles S&P 500, CAC 40, etc.)
5. Limite : 500 actions max actives simultanément

## Tasks / Subtasks
- [x] Table Universe (AC: 1)
  - [x] Table `Stock` existante dans le schéma Prisma (symbol PK, name, market, sector, active, createdAt)
  - [x] Index sur market et active déjà présent
- [x] Endpoint ajouter action (AC: 2)
  - [x] Route `POST /api/stocks`
  - [x] Body : symbol, market (optionnel), sector (optionnel)
  - [x] Validation symbol unique (409 si déjà actif)
  - [x] Auto-fetch nom via Yahoo Finance (MarketDataService.getQuote)
  - [x] Auto-détection market US/EU via suffixe symbole
  - [x] Réactivation automatique si stock existant inactif
- [x] Endpoint retirer action (AC: 3)
  - [x] Route `DELETE /api/stocks/:symbol`
  - [x] Soft delete (active = false)
- [x] Endpoint lister universe (AC: 1)
  - [x] Route `GET /api/stocks`
  - [x] Filtres : market (US/EU/ALL), active (true/false/all), search
  - [x] Pagination (limit/offset)
  - [x] Tri configurable (sortBy/sortOrder)
- [x] Import bulk CSV (AC: 4)
  - [x] Route `POST /api/stocks/import`
  - [x] Body JSON : `{ content: "csv text" }`
  - [x] Format : symbol par ligne ou symbol,market,sector
  - [x] Détection automatique header CSV
  - [x] Support line endings Windows (CRLF)
  - [x] Validation et rapport d'erreurs (created, reactivated, skipped, errors)
- [x] Implémenter limite 500 actions (AC: 5)
  - [x] Compter actions actives avant ajout (POST et import)
  - [x] Erreur 400 si limite atteinte
  - [x] Message explicite avec count actuel et slots disponibles

## Dev Notes

### Implementation Details
- Routes implémentées dans `src/server/routes/universe.ts`
- Utilise la table `Stock` existante (pas de nouvelle migration)
- Endpoints suivent le prefix `/api/stocks` conformément à l'architecture
- CSV importé via JSON body (pas de multipart) pour simplicité
- Auto-détection market EU via suffixes (.PA, .DE, .AS, etc.)
- Les noms des stocks sont enrichis via Yahoo Finance au POST, ou à "symbol" au import (enrichi plus tard par le job updateMarketData)

### Architecture References
- NFR6 : 500 actions max simultanément
- Support marchés US et EU
- Section 5.2 de l'architecture : endpoints `/stocks`

### CSV Format
```csv
symbol,market,sector
AAPL,US,Technology
MSFT,US,Technology
MC.PA,EU,Luxury
```

### Pre-configured Lists
- S&P 500 : ~500 symboles US
- CAC 40 : 40 symboles .PA
- DAX : 40 symboles .DE

### Dependencies
- Story 1.2 (Database) - Done
- Story 3.1 (MarketDataService) - Done

### Testing
- 18 tests dans `src/server/__tests__/universe.test.ts`
- Tests couvrent : CRUD, pagination, filtres, CSV import, limite 500, réactivation, soft delete

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 0.1 | Création initiale de la story | Sarah (PO) |
| 2026-02-08 | 1.0 | Implémentation complète | Dev |
