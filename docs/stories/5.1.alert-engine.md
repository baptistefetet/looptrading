# Story 5.1: Moteur d'alertes et stratégies

## Status
Draft

## Story
**As a** user,
**I want** alerts based on my trading strategies,
**so that** I don't miss buying opportunities.

## Acceptance Criteria
1. Table `AlertRule` : strategy, params, enabled
2. Implémentation des 3 stratégies :
   - Pullback sur tendance haussière
   - Breakout avec volume
   - Croisement MACD
3. Table `Alert` : symbol, strategy, score, triggeredAt, acknowledged
4. Job cron évaluant les règles toutes les 15 minutes
5. Déduplication : pas d'alerte répétée dans les 24h

## Tasks / Subtasks
- [ ] Créer table AlertRule (AC: 1)
  - [ ] Migration Prisma
  - [ ] Champs : id, strategy (enum), params (JSON), enabled, createdAt
  - [ ] Stratégies : PULLBACK, BREAKOUT, MACD_CROSS
- [ ] Implémenter stratégie Pullback (AC: 2)
  - [ ] Détection tendance haussière (prix > SMA200)
  - [ ] Prix proche SMA50 (dans les 2%)
  - [ ] RSI entre 40-50 (zone de pullback)
  - [ ] Volume en baisse (repos)
- [ ] Implémenter stratégie Breakout (AC: 2)
  - [ ] Prix dépasse résistance récente
  - [ ] Volume > 150% moyenne 20j
  - [ ] Confirmation : clôture au-dessus résistance
- [ ] Implémenter stratégie MACD Cross (AC: 2)
  - [ ] Croisement ligne MACD au-dessus Signal
  - [ ] Histogramme passe positif
  - [ ] Confirmer avec tendance (prix > SMA50)
- [ ] Créer table Alert (AC: 3)
  - [ ] Migration Prisma
  - [ ] Champs : id, symbol, strategy, score, triggeredAt, acknowledged, acknowledgedAt
  - [ ] Index sur triggeredAt et acknowledged
- [ ] Créer job d'évaluation (AC: 4)
  - [ ] Fonction `evaluateAlerts()` async
  - [ ] Enregistrer dans SchedulerService avec cron `*/15 * * * *`
  - [ ] Pour chaque action active, évaluer chaque règle enabled
  - [ ] Créer alerte si conditions remplies
- [ ] Implémenter déduplication (AC: 5)
  - [ ] Vérifier existence alerte récente (< 24h)
  - [ ] Même symbol + même stratégie
  - [ ] Skip si doublon

## Dev Notes

### Architecture References
- FR4 : Alertes lorsqu'une action atteint score > 75 ou stratégie
- FR5 : 3 stratégies définies
- NFR9 : Taux de faux positifs < 20%
- Scheduler : node-cron via SchedulerService (Story 1.5)

### Strategy Parameters (JSON)
```json
// Pullback
{ "smaPeriod": 50, "pullbackPercent": 2, "rsiMin": 40, "rsiMax": 50 }

// Breakout
{ "volumeThreshold": 1.5, "breakoutConfirmBars": 1 }

// MACD Cross
{ "requireUptrend": true, "minHistogram": 0 }
```

### Alert Evaluation Job
```typescript
async function evaluateAlerts() {
  const rules = await prisma.alertRule.findMany({ where: { enabled: true } });
  const stocks = await prisma.universe.findMany({ where: { active: true } });

  for (const stock of stocks) {
    for (const rule of rules) {
      // Check deduplication
      const recent = await prisma.alert.findFirst({
        where: {
          symbol: stock.symbol,
          strategy: rule.strategy,
          triggeredAt: { gte: new Date(Date.now() - 24 * 60 * 60 * 1000) }
        }
      });

      if (recent) continue; // Skip - already alerted

      const triggered = await evaluateStrategy(stock.symbol, rule);
      if (triggered) {
        await prisma.alert.create({
          data: {
            symbol: stock.symbol,
            strategy: rule.strategy,
            score: triggered.score,
            triggeredAt: new Date()
          }
        });
        // Trigger notification (Story 5.2)
      }
    }
  }
}
```

### Dependencies
- Story 1.5 (SchedulerService) doit être complétée
- Story 3.2-3.3 (Indicateurs) doivent être complétées
- Story 4.1 (Score) doit être complétée

### Testing
_Standards de test à définir dans le document d'architecture_

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 0.1 | Création initiale de la story | Sarah (PO) |
| 2026-01-25 | 0.2 | Migration BullMQ → node-cron | Winston (Architect) |
