# Story 3.3: Calcul des indicateurs de momentum et volatilité

## Status
Ready for Review

## Story
**As a** user,
**I want** momentum and volatility indicators,
**so that** I can assess stock dynamics.

## Acceptance Criteria
1. Calcul RSI (14 périodes)
2. Calcul MACD (12, 26, 9)
3. Calcul Bollinger Bands (20, 2)
4. Calcul OBV (On-Balance Volume)
5. Calcul Volume moyen 20 jours
6. Tous inclus dans l'endpoint indicators
7. Tests unitaires pour chaque indicateur

## Tasks / Subtasks
- [x] Implémenter calcul RSI (AC: 1)
  - [x] Fonction `calculateRSI(prices, period=14)`
  - [x] Calcul gains/pertes moyens
  - [x] Normalisation 0-100
- [x] Implémenter calcul MACD (AC: 2)
  - [x] Fonction `calculateMACD(prices, fast=12, slow=26, signal=9)`
  - [x] Ligne MACD = EMA12 - EMA26
  - [x] Ligne Signal = EMA9 du MACD
  - [x] Histogramme = MACD - Signal
- [x] Implémenter Bollinger Bands (AC: 3)
  - [x] Fonction `calculateBollingerBands(prices, period=20, stdDev=2)`
  - [x] Bande médiane = SMA20
  - [x] Bande haute = SMA + 2×écart-type
  - [x] Bande basse = SMA - 2×écart-type
- [x] Implémenter OBV (AC: 4)
  - [x] Fonction `calculateOBV(prices, volumes)`
  - [x] Cumul volume selon direction prix
- [x] Implémenter Volume moyen (AC: 5)
  - [x] Fonction `calculateAverageVolume(volumes, period=20)`
  - [x] Ratio volume actuel / moyenne
- [x] Intégrer à l'endpoint (AC: 6)
  - [x] Ajouter tous les indicateurs
  - [x] Structure de réponse cohérente
- [x] Écrire tests unitaires (AC: 7)
  - [x] Test RSI avec données connues
  - [x] Test MACD avec données connues
  - [x] Test Bollinger avec données connues
  - [x] Test OBV avec données connues

## Dev Notes
_À compléter après création du document d'architecture_

### Architecture References
- FR10 : RSI (14), MACD (12, 26, 9), Bollinger Bands (20, 2), OBV, Volume moyen 20j

### Formulas
```
RSI = 100 - (100 / (1 + RS))
où RS = moyenne des gains / moyenne des pertes

MACD Line = EMA(12) - EMA(26)
Signal Line = EMA(9) du MACD
Histogram = MACD - Signal

Bollinger Upper = SMA(20) + 2 × σ
Bollinger Lower = SMA(20) - 2 × σ

OBV = OBV précédent ± volume du jour (selon direction prix)
```

### Dependencies
- Story 3.1 (MarketDataService) doit être complétée
- Story 3.2 (SMA/EMA) doit être complétée (réutilisation des fonctions)

### Testing
_Standards de test à définir dans le document d'architecture_

## File List
| File | Action | Description |
|------|--------|-------------|
| `src/server/services/IndicatorService.ts` | Modified | Added RSI, MACD, Bollinger Bands, OBV, Average Volume calculation functions; updated StockIndicators type; updated computeIndicators/getIndicators to include all momentum indicators |
| `src/server/__tests__/indicator-service.test.ts` | Modified | Added unit tests for RSI, MACD, Bollinger Bands, OBV, OBVSeries, AverageVolume (36 new tests) |
| `src/server/__tests__/indicators-endpoint.test.ts` | Modified | Updated endpoint tests to verify all momentum indicators in response and DB persistence |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5

### Completion Notes
- All 5 momentum/volatility calculation functions implemented as pure functions
- RSI uses Wilder's smoothing method (industry standard)
- MACD reuses existing calculateEMASeries for consistency
- OBV includes both final-value and full-series variants for per-row persistence
- StockIndicators type extends old TrendIndicators with backward-compatible alias
- All 116 tests pass (53 indicator tests, 7 endpoint tests, rest unchanged)

### Debug Log References
None — no issues encountered during implementation.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 0.1 | Création initiale de la story | Sarah (PO) |
| 2026-01-31 | 1.0 | Implementation complete: RSI, MACD, BB, OBV, AvgVol + tests | James (Dev) |
