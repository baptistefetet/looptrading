# Story 1.5: Configuration du scheduler (node-cron)

## Status
Done

## Story
**As a** developer,
**I want** a simple job scheduler configured,
**so that** I can run periodic background tasks without external dependencies.

## Acceptance Criteria
1. `node-cron` installé et configuré dans `src/server/`
2. Module `SchedulerService` créé avec gestion centralisée des jobs
3. Job de test fonctionnel (log toutes les minutes en dev)
4. Gestion du démarrage/arrêt propre des jobs
5. Logs structurés pour chaque exécution de job

## Tasks / Subtasks
- [x] Installer et configurer node-cron (AC: 1)
  - [x] Installer `node-cron` et `@types/node-cron`
  - [x] Créer fichier de configuration scheduler
- [x] Créer SchedulerService (AC: 2)
  - [x] Classe singleton pour gérer tous les cron jobs
  - [x] Méthode `registerJob(name, cronExpression, handler)`
  - [x] Méthode `start()` pour démarrer tous les jobs
  - [x] Méthode `stop()` pour arrêter proprement
  - [x] Map des jobs actifs avec leur statut
- [x] Créer job de test (AC: 3)
  - [x] Job "heartbeat" toutes les minutes
  - [x] Log timestamp et statut
  - [x] Actif uniquement en développement
- [x] Gérer lifecycle (AC: 4)
  - [x] Démarrer scheduler au boot de l'API
  - [x] Arrêter proprement sur SIGTERM/SIGINT
  - [x] Éviter les exécutions concurrentes d'un même job
- [x] Configurer logging (AC: 5)
  - [x] Log début/fin de chaque job
  - [x] Log durée d'exécution
  - [x] Log erreurs avec stack trace

## Dev Notes

### Architecture References
- Remplacement de BullMQ + Redis par node-cron (simplification)
- Aucune dépendance externe requise

### Example Implementation
```typescript
import cron from 'node-cron';

class SchedulerService {
  private jobs: Map<string, cron.ScheduledTask> = new Map();

  registerJob(name: string, expression: string, handler: () => Promise<void>) {
    const task = cron.schedule(expression, async () => {
      console.log(`[${name}] Starting...`);
      const start = Date.now();
      try {
        await handler();
        console.log(`[${name}] Completed in ${Date.now() - start}ms`);
      } catch (error) {
        console.error(`[${name}] Failed:`, error);
      }
    }, { scheduled: false });

    this.jobs.set(name, task);
  }

  start() {
    this.jobs.forEach((task, name) => {
      task.start();
      console.log(`[Scheduler] Started job: ${name}`);
    });
  }

  stop() {
    this.jobs.forEach((task, name) => {
      task.stop();
      console.log(`[Scheduler] Stopped job: ${name}`);
    });
  }
}
```

### Cron Expressions Reference
- `*/15 * * * *` - Toutes les 15 minutes
- `0 * * * *` - Toutes les heures
- `0 9-17 * * 1-5` - Heures de bureau, lun-ven

### Structure cible
```
src/server/services/
└── SchedulerService.ts
```

### Testing
- Tests unitaires avec Vitest
- Mock des handlers pour tests isolés

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 0.1 | Création initiale de la story | Sarah (PO) |
| 2026-01-25 | 0.2 | Remplacement Redis/BullMQ par node-cron | Winston (Architect) |
| 2026-01-25 | 0.3 | Mise à jour paths pour architecture v3.0 | Winston (Architect) |
