# Story 3.4: Job de mise à jour des données

## Status
Done

## Story
**As a** user,
**I want** market data to update automatically,
**so that** I always have recent information.

## Acceptance Criteria
1. Job cron `updateMarketData` enregistré dans SchedulerService
2. Exécution toutes les 15 minutes pendant heures de marché
3. Mise à jour des prix et indicateurs pour toutes les actions surveillées
4. Gestion des erreurs avec logging détaillé
5. Logs de progression et statistiques

## Tasks / Subtasks
- [x] Créer job updateMarketData (AC: 1)
  - [x] Fonction `updateMarketData()` async
  - [x] Enregistrer dans SchedulerService avec cron `*/15 * * * *`
  - [x] Intégrer au démarrage de l'API
- [x] Configurer scheduling intelligent (AC: 2)
  - [x] Vérifier si heures de marché avant exécution
  - [x] Heures US (NYSE/NASDAQ) : 9:30-16:00 EST
  - [x] Heures EU (Euronext) : 9:00-17:30 CET
  - [x] Skip weekends (samedi/dimanche)
  - [x] Log "skipped - market closed" si hors horaires
- [x] Implémenter mise à jour batch (AC: 3)
  - [x] Récupérer liste actions actives depuis `Stock`
  - [x] Fetch données en batch avec rate limiting
  - [x] Recalculer tous les indicateurs
  - [x] Sauvegarder en base (upsert)
- [x] Gérer erreurs (AC: 4)
  - [x] Try/catch par action (ne pas bloquer les autres)
  - [x] Compteur d'erreurs par exécution
  - [x] Log détaillé des échecs avec symbol
  - [x] Continuer même si certaines actions échouent
- [x] Configurer logging et stats (AC: 5)
  - [x] Log début du job avec timestamp
  - [x] Log nombre d'actions à traiter
  - [x] Log progression (10%, 50%, 100%)
  - [x] Log récapitulatif : succès, échecs, durée totale

## Dev Notes

### Architecture References
- Scheduler : node-cron via SchedulerService (Story 1.5)
- NFR3 : Latence données ≤ 15 minutes
- NFR6 : 500 actions simultanément

### Market Hours Detection
```typescript
function isMarketOpen(): { us: boolean; eu: boolean } {
  const now = new Date();
  const day = now.getUTCDay();

  // Skip weekends
  if (day === 0 || day === 6) return { us: false, eu: false };

  const utcHour = now.getUTCHours();
  const utcMinute = now.getUTCMinutes();
  const utcTime = utcHour * 60 + utcMinute;

  // US: 14:30-21:00 UTC (9:30-16:00 EST)
  const usOpen = utcTime >= 14 * 60 + 30 && utcTime < 21 * 60;

  // EU: 8:00-16:30 UTC (9:00-17:30 CET)
  const euOpen = utcTime >= 8 * 60 && utcTime < 16 * 60 + 30;

  return { us: usOpen, eu: euOpen };
}
```

### Job Structure
```typescript
async function updateMarketData() {
  const markets = isMarketOpen();
  if (!markets.us && !markets.eu) {
    console.log('[updateMarketData] Skipped - markets closed');
    return;
  }

  const stocks = await prisma.universe.findMany({ where: { active: true } });
  let success = 0, failed = 0;

  for (const stock of stocks) {
    try {
      await updateStockData(stock.symbol);
      success++;
    } catch (error) {
      failed++;
      console.error(`[updateMarketData] Failed: ${stock.symbol}`, error);
    }
  }

  console.log(`[updateMarketData] Done: ${success} success, ${failed} failed`);
}
```

### Dependencies
- Story 1.5 (SchedulerService) doit être complétée
- Story 3.1-3.3 (MarketDataService et indicateurs)

### Testing
- 16 tests pour `isMarketOpen` (weekends, US/EU hours, overlap, edge cases)
- 12 tests pour `updateMarketData` job (mocked dependencies)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 0.1 | Création initiale de la story | Sarah (PO) |
| 2026-01-25 | 0.2 | Migration BullMQ → node-cron | Winston (Architect) |
| 2026-01-31 | 1.0 | Implémentation complète | Dev |
