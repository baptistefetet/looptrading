# Story 4.2: API Screener avec filtres

## Status
Done

## Story
**As a** user,
**I want** to filter stocks by technical criteria,
**so that** I can find stocks matching my strategy.

## Acceptance Criteria
1. Endpoint `GET /api/screener` avec query params :
   - `minScore`, `maxScore`
   - `minRsi`, `maxRsi`
   - `aboveSma50`, `aboveSma200`
   - `minVolume`
   - `market` (US, EU, ALL)
2. Pagination (limit, offset)
3. Tri par score, symbol, ou tout indicateur
4. Réponse < 500ms pour 500 actions
5. Tests d'intégration

## Tasks / Subtasks
- [x] Créer endpoint screener (AC: 1)
  - [x] Route `GET /api/screener`
  - [x] Query params avec validation Zod
  - [x] Filtres : minScore, maxScore
  - [x] Filtres : minRsi, maxRsi
  - [x] Filtres : aboveSma50, aboveSma200 (boolean)
  - [x] Filtres : minVolume (ratio vs moyenne)
  - [x] Filtre : market (enum US, EU, ALL)
- [x] Implémenter pagination (AC: 2)
  - [x] Query params : limit (default 50, max 100)
  - [x] Query params : offset (default 0)
  - [x] Retourner total count dans réponse
  - [x] Headers pagination (X-Total-Count)
- [x] Implémenter tri (AC: 3)
  - [x] Query param : sortBy (score, symbol, rsi, volume, etc.)
  - [x] Query param : sortOrder (asc, desc)
  - [x] Default : score desc
- [x] Optimiser performance (AC: 4)
  - [x] Index base de données sur colonnes filtrées
  - [x] Query optimisée SQL brut (raw query)
  - [x] Benchmark avec 500 actions
  - [x] Cache si nécessaire
- [x] Écrire tests d'intégration (AC: 5)
  - [x] Test filtres individuels
  - [x] Test combinaison de filtres
  - [x] Test pagination
  - [x] Test tri
  - [x] Test performance

## Dev Notes

### Architecture References
- FR1 : Filtrer actions selon critères techniques configurables
- NFR6 : 500 actions simultanément

### Implementation Details
- Raw SQL via `prisma.$queryRawUnsafe` pour supporter les comparaisons inter-colonnes (close > sma50, volume/avgVol20)
- Latest data per symbol via subquery `MAX(date)`
- Previous close via LEFT JOIN pour calcul du % change
- NULLs poussés en fin de tri via CASE WHEN
- Index ajouté sur `score` dans StockData

### API Response Format
```json
{
  "data": [
    {
      "symbol": "AAPL",
      "name": "Apple Inc.",
      "price": 150.25,
      "change": 2.5,
      "score": 85,
      "rsi": 55,
      "aboveSma50": true,
      "aboveSma200": true,
      "volume": 1.5
    }
  ],
  "meta": {
    "total": 234,
    "limit": 50,
    "offset": 0
  }
}
```

### Dependencies
- Story 4.1 (ScoringService) doit être complétée
- Story 3.2-3.3 (Indicateurs) doivent être complétées

### Testing
32 tests d'intégration couvrant filtres, tri, pagination et validation.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-25 | 0.1 | Création initiale de la story | Sarah (PO) |
| 2026-02-08 | 1.0 | Implémentation complète | Dev |
